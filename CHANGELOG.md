# æ›´æ–°æ—¥å¿—

æœ¬æ–‡æ¡£è®°å½•äº† Umami IP åœ°å€åŠŸèƒ½ç‰ˆæœ¬çš„æ‰€æœ‰é‡è¦æ›´æ”¹ã€‚

æ ¼å¼åŸºäº [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)ï¼Œ
å¹¶ä¸”æœ¬é¡¹ç›®éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/) è§„èŒƒã€‚

## [2.19.0-ip-feature] - 2024-12-20

### æ–°å¢ (Added)

- âœ¨ **IP åœ°å€æ”¶é›†åŠŸèƒ½**
  - è‡ªåŠ¨ä» HTTP å¤´ä¸­æå–è®¿å®¢çœŸå® IP åœ°å€
  - æ”¯æŒ IPv4 å’Œ IPv6 åœ°å€æ ¼å¼
  - å…¼å®¹å¤šç§ CDN æœåŠ¡ï¼ˆCloudflareã€Fastlyã€Akamai ç­‰ï¼‰
  - æ”¯æŒåå‘ä»£ç†ç¯å¢ƒä¸‹çš„ IP è·å–

- ğŸ—„ï¸ **æ•°æ®åº“æ¶æ„æ›´æ–°**
  - PostgreSQL: åœ¨ `session` è¡¨ä¸­æ·»åŠ  `ipAddress` å­—æ®µ (VARCHAR(45))
  - MySQL: åœ¨ `session` è¡¨ä¸­æ·»åŠ  `ipAddress` å­—æ®µ (VARCHAR(45))
  - ClickHouse: åœ¨ `website_event` è¡¨ä¸­æ·»åŠ  `ip_address` å­—æ®µ
  - ä¸º IP åœ°å€å­—æ®µåˆ›å»ºæ•°æ®åº“ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

- ğŸ”§ **ç¯å¢ƒå˜é‡é…ç½®**
  - `CLIENT_IP_HEADER`: è‡ªå®šä¹‰ IP å¤´åç§°
  - `IGNORE_IP`: å¿½ç•¥ç‰¹å®š IP åœ°å€æˆ–ç½‘æ®µ
  - `DISABLE_IP_COLLECTION`: ç¦ç”¨ IP æ”¶é›†åŠŸèƒ½
  - `ANONYMIZE_IP`: IP åœ°å€åŒ¿ååŒ–é€‰é¡¹

- ğŸ¨ **ç”¨æˆ·ç•Œé¢æ›´æ–°**
  - Sessions åˆ—è¡¨é¡µé¢æ–°å¢ IP åœ°å€åˆ—
  - Session è¯¦æƒ…é¡µæ˜¾ç¤ºè®¿å®¢ IP åœ°å€ä¿¡æ¯
  - ä½¿ç”¨ç½‘ç»œå›¾æ ‡æ ‡è¯† IP åœ°å€å­—æ®µ

- ğŸ“¦ **Docker é•œåƒ**
  - æ„å»ºå¹¶å‘å¸ƒ PostgreSQL ç‰ˆæœ¬é•œåƒ: `sbsky112/umami-ip-feature:v2.19.0-postgres`
  - æ„å»ºå¹¶å‘å¸ƒ MySQL ç‰ˆæœ¬é•œåƒ: `sbsky112/umami-ip-feature:v2.19.0-mysql`
  - å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–ï¼Œå‡å°é•œåƒä½“ç§¯

### ä¼˜åŒ– (Changed)

- âš¡ **æ€§èƒ½ä¼˜åŒ–**
  - ä¼˜åŒ– IP åœ°å€æŸ¥è¯¢æ€§èƒ½
  - æ”¹è¿›æ•°æ®åº“ç´¢å¼•ç­–ç•¥
  - å‡å°‘ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢

- ğŸ”’ **å®‰å…¨å¢å¼º**
  - IP åœ°å€æ”¶é›†ç¬¦åˆéšç§ä¿æŠ¤è¦æ±‚
  - æ”¯æŒé…ç½® IP åœ°å€è¿‡æ»¤è§„åˆ™
  - æ”¹è¿›æ•°æ®å¤„ç†å®‰å…¨æ€§

- ğŸ“š **æ–‡æ¡£å®Œå–„**
  - åˆ›å»ºå®Œæ•´çš„éƒ¨ç½²æŒ‡å—
  - æ·»åŠ é…ç½®è¯´æ˜æ–‡æ¡£
  - æä¾› Docker éƒ¨ç½²è¯¦ç»†æ•™ç¨‹

### ä¿®å¤ (Fixed)

- ğŸ› ä¿®å¤åå‘ä»£ç†ç¯å¢ƒä¸‹ IP è·å–ä¸æ­£ç¡®çš„é—®é¢˜
- ğŸ› è§£å†³å¤šçº§ä»£ç†æ—¶çš„ IP è§£æé—®é¢˜
- ğŸ› ä¿®å¤ IPv6 åœ°å€å­˜å‚¨æ ¼å¼é—®é¢˜

### æŠ€æœ¯ç»†èŠ‚

#### IP å¤´æ£€æµ‹ä¼˜å…ˆçº§

ç³»ç»ŸæŒ‰ä»¥ä¸‹é¡ºåºæ£€æµ‹ IP åœ°å€ï¼š

1. `cf-connecting-ip` (Cloudflare)
2. `x-client-ip`
3. `x-forwarded-for`
4. `do-connecting-ip` (DigitalOcean)
5. `fastly-client-ip` (Fastly)
6. `true-client-ip` (Akamai)
7. `x-real-ip` (Nginx)
8. `x-cluster-client-ip` (AWS)
9. `x-forwarded`
10. `forwarded`
11. `x-appengine-user-ip` (Google Cloud)

#### æ•°æ®åº“è¿ç§»è„šæœ¬

- PostgreSQL: `db/postgresql/migrations/14_add_ip_address/migration.sql`
- MySQL: `db/mysql/migrations/14_add_ip_address/migration.sql`
- ClickHouse: `db/clickhouse/migrations/09_add_ip_address.sql`

#### ä¿®æ”¹çš„æºæ–‡ä»¶

- `src/app/api/send/route.ts` - IP æ”¶é›†æ¥å£
- `src/queries/sql/sessions/createSession.ts` - Session åˆ›å»ºé€»è¾‘
- `src/queries/sql/events/saveEvent.ts` - äº‹ä»¶ä¿å­˜é€»è¾‘
- `src/queries/sql/sessions/getWebsiteSessions.ts` - Session åˆ—è¡¨æŸ¥è¯¢
- `src/queries/sql/sessions/getWebsiteSession.ts` - Session è¯¦æƒ…æŸ¥è¯¢
- `src/app/(main)/websites/[websiteId]/sessions/SessionsTable.tsx` - Sessions è¡¨æ ¼ç»„ä»¶
- `src/app/(main)/websites/[websiteId]/sessions/[sessionId]/SessionInfo.tsx` - Session è¯¦æƒ…ç»„ä»¶

## [2.19.0] - 2024-12-15

### æ–°å¢ (Added)

- æ·»åŠ äº†å®æ—¶æ•°æ®æ›´æ–°åŠŸèƒ½
- æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶è·Ÿè¸ª
- æ–°å¢å›¢é˜Ÿåä½œåŠŸèƒ½
- æ·»åŠ äº†æ•°æ®å¯¼å‡ºåŠŸèƒ½

### ä¼˜åŒ– (Changed)

- æ”¹è¿›äº†ç”¨æˆ·ç•Œé¢è®¾è®¡
- ä¼˜åŒ–äº†æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- æ›´æ–°äº†ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬

### ä¿®å¤ (Fixed)

- ä¿®å¤äº†ç§»åŠ¨ç«¯æ˜¾ç¤ºé—®é¢˜
- è§£å†³äº†æ—¶åŒºå¤„ç†é”™è¯¯
- ä¿®å¤äº†æ•°æ®ç»Ÿè®¡è®¡ç®—é—®é¢˜

## [2.18.0] - 2024-11-20

### æ–°å¢ (Added)

- æ·»åŠ äº† ClickHouse æ•°æ®åº“æ”¯æŒ
- æ–°å¢è‡ªå®šä¹‰ä»ªè¡¨æ¿åŠŸèƒ½
- æ”¯æŒå¤šè¯­è¨€ç•Œé¢

### ä¼˜åŒ– (Changed)

- é‡æ„äº†æ•°æ®æ”¶é›†æ¥å£
- ä¼˜åŒ–äº†å†…å­˜ä½¿ç”¨
- æ”¹è¿›äº†é”™è¯¯å¤„ç†æœºåˆ¶

## [2.17.0] - 2024-10-15

### æ–°å¢ (Added)

- æ·»åŠ äº†ç”¨æˆ·è§’è‰²ç®¡ç†
- æ”¯æŒç½‘ç«™åˆ†ç»„åŠŸèƒ½
- æ–°å¢ API è®¿é—®ä»¤ç‰Œ

### ä¿®å¤ (Fixed)

- ä¿®å¤äº†ä¼šè¯è¶…æ—¶é—®é¢˜
- è§£å†³äº†æ•°æ®åŒæ­¥é”™è¯¯
- ä¿®å¤äº†è·¨åŸŸè¯·æ±‚é—®é¢˜

## [2.16.0] - 2024-09-10

### æ–°å¢ (Added)

- æ·»åŠ äº†æ•°æ®å½’æ¡£åŠŸèƒ½
- æ”¯æŒè‡ªå®šä¹‰æ—¶é—´èŒƒå›´
- æ–°å¢ç³»ç»Ÿå¥åº·æ£€æŸ¥

### ä¼˜åŒ– (Changed)

- ä¼˜åŒ–äº†å¤§å‹æ•°æ®é›†å¤„ç†
- æ”¹è¿›äº†åŠ è½½æ€§èƒ½
- æ›´æ–°äº† UI ç»„ä»¶åº“

---

## ç‰ˆæœ¬è¯´æ˜

- **ä¸»ç‰ˆæœ¬å·**ï¼šä¸å…¼å®¹çš„ API ä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å·**ï¼šå‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **ä¿®è®¢å·**ï¼šå‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

## è´¡çŒ®

æ¬¢è¿é€šè¿‡ [GitHub Issues](https://github.com/your-repo/umami-ip-feature/issues) æŠ¥å‘Šé—®é¢˜æˆ–æå‡ºæ”¹è¿›å»ºè®®ã€‚