version: '3.8'

services:
  umami:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DATABASE_TYPE: mysql
        BASE_PATH: 
        NODE_OPTIONS: --max-old-space-size=4096
    image: umami:mysql-local
    container_name: umami-app-mysql
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: mysql://umami:${MYSQL_PASSWORD:-umami}@db:3306/umami
      DATABASE_TYPE: mysql
      APP_SECRET: ${APP_SECRET:-replace-me-with-a-random-string}
      NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${TURNSTILE_SITE_KEY:-}
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY:-}
      NODE_ENV: production
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - umami-network
    volumes:
      - umami-data:/app/data

  db:
    image: mysql:8.0
    container_name: umami-db-mysql
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: umami
      MYSQL_USER: umami
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-umami}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
    volumes:
      - umami-db-data:/var/lib/mysql
      - ./docker/mysql:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "$$MYSQL_USER", "--password=$$MYSQL_PASSWORD"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - umami-network
    cap_add:
      - SYS_NICE

networks:
  umami-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  umami-db-data:
    driver: local
  umami-data:
    driver: local